---
title: 论文笔记 Real Shading in Unreal Engine 4
tags:
---

## 材质模型

我们的材质模型是迪士尼的简化，着重于实时渲染的效率。限制参数的数量对于充分利用GBuffer极其重要，还有减少纹理的存储获取、最小化在像素着色器中的混合不同材质层的消耗。

基础的材质模型有以下部分：BaseColor Metallic Roughness Cavity

前3个和迪士尼模型中的概念相同。Cavity用于强调阴影，当图形超出阴影系统的处理范围，通常由于图形只存在于normal map中。举例：地板间的裂缝，衣服的缝合处。

我们不喜欢Specular这个参数，首先命名上会造成误解，要理解specular强度和roughness的差别；还有默认值为0.5，对应了4%的反射率。这个参数在小范围的阴影渲染中有效。后来我们发现IOR这个变量对于非金属没有太大意义，所以用更容易理解的参数Cavity替换了Specular

还有一些迪士尼模型的参数并没有放入基础模型，而是作为特例：Subsuface Anisotropy Clearcoat Sheen

Elemental demo用到了Subsurface模型，对于皮肤的渲染我们还有额外的着色模型。未来我们考虑使用 延迟/前向 着色方法的混合来更好的支持特定的着色模型。目前我们只使用了延迟渲染（2013年），在GBuffer中存储了着色模型的ID来动态的控制不同着色模型的分支。

C:\UnrealEngine\Engine\Shaders\Private\ShadingCommon.ush
<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510094258.jpg" width="100%">
</div>
<br>

### 经历
Roughness：更高的值意味着更不强烈的高光，值越小高光越分散
<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510161153.jpg" width="100%">
</div>
<center>roughness为0，高光效果明显</center>
<br>

<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510161230.jpg" width="100%">
</div>
<center>roughness为1，高光效果分散/消失</center>
<br>

<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510161605.jpg" width="100%">
</div>
<center>specular为0时，roughness无论取多少，高光效果分散/消失</center>
<br>

高光度/Specular 用在非金属表面上调整当前的高光量，取值0-1，默认0.5

一个我已经收到无数次的问题是: “Metallic是二值化的吗？”，我原本解释了混合或分层材质的微妙之处。后来我明白了最好的办法就是说“是的！”，原因是艺术家们一开始不愿意设定绝对的参数；我通常会发现金属的金属值是0.8。接下来讨论的 Material layers（材料层）应该涵盖了当metallic不是0或1时99%的情况。

在过渡过程中，我们遇到了一些问题，材质不能再被复制。其中最重要的一套来自《堡垒之夜》，这是Epic目前正在制作的一款游戏。《堡垒之夜》的艺术方向是非写实主义的，并有意使用互补色来进行漫反射和高光反射，这在物理上是不合理的，也不能在我们的新材质模型中表现出来。经过长时间的讨论，我们决定用一个引擎的开关继续支持旧的 DiffuseColor/SpecularColor，以保持《堡垒之夜》的质量，因为它的开发已经深入了。然而，我们不认为新的材质模型会像迪士尼在《无敌破坏王》中使用的那样排除非真实感渲染，所以我们打算在未来的所有项目中使用它。

### 材质分层

混合来自来自共享库的材质层比我们之前的方法提供了许多好处，可以独立的声明材质的参数值，参数值是为特定的模型创作的不同贴图：
- 在多个资产中重用工作。
- 降低单一资产的复杂性。
- 统一和集中定义游戏外观的材质，使美术和技术方向更简单。

为了完全接受这个新的工作流程，我们需要重新考虑我们的工具。虚幻引擎在早期的UE3中就有一个基于节点图形的材质编辑器。这个节点图形指定了输入(纹理、常量)、操作和输出，它们被编译成着色器代码。

虽然材质层是大部分工作的主要目标，但令人惊讶的是，在工具端几乎不需要添加什么来支持材料层的创作和混合。在UE4的材质编辑器中，材质蓝图的部分已经可以被包装为材质函数，并用于多个材质。这个功能非常适合实现材质层。将材料层保持在基于节点的编辑器内，而不是在顶层作为一个固定的功能系统，允许层以可编程的方式映射和组合。

为了简化工作流程，我们添加了一个新的数据类型，材料属性，它包含所有的材料输出数据。这种新类型，像我们的其他类型，可以通过单引脚传进传出材料函数的数据，通过连接线传递，并直接输出。有了这些改变，材质层可以被拖动作为输入，组合，操作和输出，就像之前的纹理一样。事实上，大多数材质蓝图倾向于更简单，因为主要采用材质层的映射和混合层方法去自定义特定材质。这比过去存在的操作特定参数的方法简单得多。

由于有一小组的视觉上线性的材质参数，它实际上是实用的完全在着色器中混合层。我们认为这提供了一个实质性的质量上的提高相比纯粹的离线复合系统。纹理数据的表面分辨率可以非常高，因为能够在不同的频率映射数据：逐顶点或低频纹理数据可以是唯一的，层混合蒙版，法线贴图和空腔贴图（Cavity Maps）是每个网格指定的，材质层平铺在网格表面。更高级的例子可能有更高的使用频率。尽管由于着色器的成本的原因限制了层数，我们的美工还没有遇到限制造成的问题。

一个值得关注的地方是，在某些情况下，美工们已经通过将一个网格分割成多个部分，从而绕过了着色层的限制，从而导致更多的draw call。虽然我们期望更好的绘制调用次数由于UE4在CPU层代码的优化，这似乎在未来是一个问题的来源。我们还没有研究的一个领域是在一个图层有100%覆盖的区域使用动态分支来降低着色器的成本。

到目前为止，我们在材质层方面的经验是非常乐观的。我们看到了生产率的提升和质量的大幅提高。我们希望改善材质层库的美术界面，使其更容易找到和预览层。我们还打算研究一个离线合成/烘烤系统，除了我们当前的运行时系统，以支持更多的层和提供更好的可伸缩性。


<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510181744.jpg" width="100%">
</div>
<center>图7：许多材料层转换并与锈迹的混合。</center>
<br>
<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510181858.jpg" width="100%">
</div>
<center>图8:利用多个细节频率的材质分层结果。</center>
<br>

## 光照模型

和着色模型一样，我们希望通过使其更加基于物理来改进我们的光照模型。我们关注的两个方面是光照衰减和区域光。

改善光衰减相对简单:我们采用了物理上精确的反平方衰减，并切换到lumens作为亮度单位。也就是说，我们要处理的一个小问题是这种衰减函数没有到达零的距离。但为了提高效率——无论是实时计算还是离线计算——我们仍然需要人为地限制灯光的影响范围。有很多方法可以解决这个问题，但是我们选择以这样一种方式对反平方函数进行截断限制，使得大部分光线的影响效果相对不受影响，同时仍然提供一个到零的平滑过渡。这有一个很好的属性，即修改光的半径并不会改变它的有效亮度，这在照明被美工固定时很重要，但由于性能原因，光的范围仍然需要调整。

<br>
<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510190219.jpg" width="80%">
</div>
<center>C:\UnrealEngine\Engine\Shaders\Private\DeferredLightingCommon.ush</center>
<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510190239.jpg" width="40%">
</div>
<br>

分母中的1是为了防止函数在靠近光源的距离取得无穷大。在不需要物理正确性的情况下，它可以作为美工控制的参数公开。

这个简单的改变带来的质量差异，尤其是在有很多本地光源的场景中极为有效。
<br>
<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210510194144.jpg" width="100%">
</div>
<center>图9：逆平方衰减可以得到更自然的结果</center>
<br>

## 区域光

面光源/区域光源不只是生成更真实的图像；当使用基于物理的材质时，它们也相当重要。我们发现，如果没有它们，美工们直觉地倾向于避免画非常低的粗糙值，因为这导致很多无穷小的高光，这看起来不自然。本质上，他们是在试图重现精确光源的区域照明效果。

不幸的是，这种反应导致了阴影和照明之间的耦合，打破了基于物理渲染的核心原则之一：当在不同的照明环境中使用相同材质时，不需要对其进行修改。

区域光是一个活跃的研究领域。在离线渲染中，常见的解决方案是从光源表面的多个点进行光照——要么使用均匀采样，要么使用重要采样。这对于实时渲染是完全不切实际的。在讨论可能的解决方案之前，下面是我们的需求：

- 一致的材质表现：使用漫反射BRDF和镜面BRDF评估的能量值没有显著差异。
- 当角度接近零时接近点光源方法：我们不想失去我们的着色模型的任何方面来实现这一点。
- 在任何地方足够快：否则，我们无法解决前面提到的“粗糙度偏差”问题。

### 广告牌反射
广告牌反射是IBL的一种形式，可以用于离散光源。存储发出光的2D图像被映射到3d空间中的矩形。类似于环境贴图的预过滤，对不同大小的高光分布锥进行图像的预过滤。从这个图像计算高光着色可以被认为是一种锥跟踪的形式，其中锥近似于高光法线分布函数（NDF）。圆锥体中心的射线横穿广告牌平面。然后利用图像中的交点作为纹理坐标，并利用交点的锥体半径推导出适当的预过滤mip级别。遗憾的是，虽然图像可以直接表达非常复杂的区域光源，但广告牌反射却不能满足我们的第二个要求，原因有很多：
- 图像在平面上进行了预滤波，因此在图像空间中可以表示有限的立体角。（锥体的立体角大小定义为，以锥体的顶点为球心作球面，该锥体在球表面截取的面积与球半径平方之比，单位为球面度。描述的是站在某一点的观察者测量到的物体大小的尺度）
- 当射线不与平面相交时，就没有数据。
- 光向量l是未知的，或者假设它是反射向量。

### 锥体交集
圆锥跟踪不需要预过滤;它可以通过分析来实现。我们曾用Oat的锥锥交点方程来模拟一个球体，但它太昂贵了，不实用。Drobot最近提出的另一种方法是将圆锥与面对着色点的圆盘相交。一个近似于NDF的多项式，然后在相交区域上分段积分。
随着Drobot最近的进展，这似乎是一个有趣的研究领域，但在目前的形式，它不能满足我们的要求。由于使用锥形，高光分布必须是径向对称的。这排除了拉伸高光，这是微表面高光模型的一个非常重要的特性。此外，就像广告牌反射一样，他没有定义光方向。

### 修改高光D项
我们去年提出的一种方法是根据光源的立体角来修改高光分布。这背后的理论是像考虑D(h)一样考虑光源的分布，对应到锥角。将一个分布与另一个分布进行卷积，可以近似地将两个锥的角度相加得到一个新的锥。为了实现这一点，将公式3转换为一个有效的锥角，加上光源的角度，然后再转换回来。α'现在被用来代替α。我们使用下面的近似来做这个:
<div align="center">
<img src="http://82.156.182.226:8099/img/my/QQ截图20210511102109.jpg" width="40%">
</div>
<br>
虽然这种技术很有效，但不幸的是，它不能满足我们的第一个要求，因为非常有光泽的材料在大面积灯光下显得粗糙。这可能听起来很明显，但当高光NDF是紧凑的(例如blinn - phong)时，该技术工作得更好，从而更好地匹配光源的分布。对于我们选择的着色模型(基于GGX)，它是不可用的。